<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор PNG слайдів з CSV</title>
    <style>
        body {
            font-family: Verdana, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            color: black; /* Base text color */
        }

        h1 {
            color: #333; /* A softer black for the main title */
        }

        .instruction-container {
            background-color: white; /* White background for containers */
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: left;
            max-width: 800px; /* Limit width for better readability */
        }
        
        .uploader-container {
            background-color: white;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px 20px;
            margin-bottom: 20px;
            text-align: center;
            max-width: 800px;
            width: 100%;
            box-sizing: border-box;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .uploader-container.dragover {
            background-color: #e9f5ff;
            border-color: #0b5394;
        }

        #csvFileInput {
            display: none;
        }

        .uploader-text {
            color: #555;
            font-size: 18px;
        }

        #fileName {
            margin-top: 10px;
            font-style: italic;
            color: #333;
            font-weight: bold;
        }

        .slide-container {
            width: 1280px;
            height: 720px;
            background-color: white; /* White slide background */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .slide-content {
            padding: 25px;
            box-sizing: border-box;
            width: 100%;
            height: 100%;
        }

        .slide-header {
            font-size: 24px;
            font-weight: bold;
            color: #0b5394; /* Primary Blue for header text */
            margin-bottom: 15px;
            border-bottom: 2px solid #b00000; /* Accent Red for the border */
            padding-bottom: 10px;
        }

        .slide-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .slide-table th,
        .slide-table td {
            border: 1px solid #ddd;
            padding: 4px 5px;
            text-align: left;
            word-wrap: break-word;
            vertical-align: top;
        }

        .slide-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            font-size: 14px;
        }

        .slide-table td {
            font-size: 12px;
            line-height: 1.25;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .controls button {
            background-color: #0b5394; /* Primary Blue for all buttons */
            color: white; /* White text */
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
        }

        .controls button:hover {
            background-color: #084175; /* A slightly darker blue for hover */
        }

        .controls button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #slide-indicator {
            font-size: 18px;
            font-weight: bold;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>

    <h1>Генератор 16:9 PNG слайдів з CSV</h1>
    
    <div class="instruction-container">
        <p><b>Інструкція з використання:</b></p>
        <ol>
            <li>Відкрийте потрібний Вам файл у Google Таблицях</li>
            <li>Натисніть зліва згори Файл > Завантажити</li>
            <li>Оберіть формат CSV (розділені комами) та збережіть</li>
            <li><b>Перетягніть файл у поле нижче</b> або натисніть на нього, щоб обрати файл</li>
            <li>Готово! Збережіть PDF (але можна зберігати окремі слайди)</li>
        </ol>
        <p><b>Звертаю Вашу увагу на те що:</b></p>
        <ul>
            <li>треба ретельно перевірити все на помилки<br>(і виправити таблицю та скачати CSV ще раз)</li>
            <li>вся генерація відбувається локально (у Вас!)<br>(тобто ці дані в Інтернет нікуди не йдуть)</li>
        </ul>
    </div>

    <label for="csvFileInput" id="uploader-container" class="uploader-container">
        <div class="uploader-text">Натисніть або перетягніть сюди CSV файл</div>
        <div id="fileName">Файл не обрано</div>
    </label>
    <input type="file" id="csvFileInput" accept=".csv">

    <div id="slide-container" class="slide-container" style="display:none;">
        <!-- Slides will be generated here -->
    </div>

    <div id="controls" class="controls" style="display:none;">
        <button id="prev-slide">Попередній</button>
        <span id="slide-indicator"></span>
        <button id="next-slide">Наступний</button>
        <button id="download-png">Завантажити як PNG</button>
        <button id="download-zip">Завантажити всі (ZIP)</button>
        <button id="download-pdf">Завантажити всі (PDF)</button>
    </div>
    
    <div id="measuring-container" class="slide-container" style="position: absolute; left: -9999px; top: -9999px; z-index: -1;"></div>

    <script>
        const uploaderContainer = document.getElementById('uploader-container');
        const fileInput = document.getElementById('csvFileInput');
        const fileNameDisplay = document.getElementById('fileName');

        let slidesData = [];
        let currentSlideIndex = 0;

        uploaderContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploaderContainer.classList.add('dragover');
        });

        uploaderContainer.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploaderContainer.classList.remove('dragover');
        });

        uploaderContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploaderContainer.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length) {
                processFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length) {
                processFile(files[0]);
            }
        });
        
        function processFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert("Помилка: будь ласка, завантажте файл у форматі .csv");
                resetUI();
                return;
            }

            fileNameDisplay.textContent = file.name;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    const requiredColumns = [
                        'Назва тематичного напряму відповідно наказу МОН України',
                        'ПІБ наукового керівника, науковий ступінь, вчене звання, назва роботи, категорія та тип роботи',
                        'Структурний підрозділ',
                        'Термін виконання та орієнтований обсяг фінансування',
                        'Бали експертів, середній бал',
                        'Дата та № витягу засідання експертної комісії (голова комісії), щодо проходження І етапу Конкурсу'
                    ];
                    const actualColumns = results.meta.fields;
                    
                    const missingColumns = requiredColumns.filter(col => !actualColumns.includes(col));
                    
                    if (missingColumns.length > 0) {
                        alert(`Помилка: файл CSV не має необхідних стовпців.\n\nВідсутні стовпці:\n- ${missingColumns.join('\n- ')}\n\nБудь ласка, виправте файл і спробуйте ще раз.`);
                        resetUI();
                        return;
                    }

                    let lastDepartment = "";
                    const filledData = results.data.map(row => {
                        const department = row['Структурний підрозділ'];
                        if (department && department.trim() !== '') {
                            lastDepartment = department.trim();
                        } else {
                            row['Структурний підрозділ'] = lastDepartment;
                        }
                        return row;
                    });

                    const processedData = processData(filledData);
                    slidesData = generateSlides(processedData);
                    if (slidesData.length > 0) {
                        currentSlideIndex = 0;
                        renderSlide(currentSlideIndex);
                        document.getElementById('slide-container').style.display = 'block';
                        document.getElementById('controls').style.display = 'flex';
                    }
                },
                error: function(err) {
                    alert("Помилка під час аналізу CSV файлу: " + err.message);
                    resetUI();
                }
            });
        }
        
        function resetUI() {
            fileNameDisplay.textContent = 'Файл не обрано';
            fileInput.value = '';
            slidesData = [];
            document.getElementById('slide-container').style.display = 'none';
            document.getElementById('controls').style.display = 'none';
        }
        
        function formatWorkName(text) {
            if (!text) return '';

            const words = text.split(' ');
            let processedText = text; 
            if (words.length >= 3) {
                const underlinedName = `<u>${words.slice(0, 3).join(' ')}</u>`;
                const restOfString = words.slice(3).join(' ');
                processedText = restOfString ? `${underlinedName} ${restOfString}` : underlinedName;
            }

            const startMarker = "назва роботи:";
            const endMarkers = ["категорія", "тип роботи"];
            
            const lowerText = processedText.toLowerCase(); 
            const startIndexRaw = lowerText.indexOf(startMarker);

            if (startIndexRaw === -1) {
                return processedText;
            }

            const workNameStartIndex = startIndexRaw + startMarker.length;
            
            let workNameEndIndex = processedText.length;
            for (const marker of endMarkers) {
                const potentialEndIndex = lowerText.indexOf(marker, workNameStartIndex);
                if (potentialEndIndex !== -1 && potentialEndIndex < workNameEndIndex) {
                    workNameEndIndex = potentialEndIndex;
                }
            }
            
            const beforePart = processedText.substring(0, workNameStartIndex);
            const workNamePart = processedText.substring(workNameStartIndex, workNameEndIndex);
            const afterPart = processedText.substring(workNameEndIndex);
            
            const trimmedWorkName = workNamePart.trim();
            
            const leadingSpace = workNamePart.match(/^\s*/)[0] || '';
            const trailingSpace = workNamePart.match(/\s*$/)[0] || '';

            if (trimmedWorkName) {
                return `${beforePart}${leadingSpace}<b>${trimmedWorkName}</b>${trailingSpace}${afterPart}`;
            }

            return processedText;
        }
        
        // **MODIFICATION START: Enhanced logic for finance column**
        function formatTermAndFinance(text) {
            if (!text) return '';
            
            // Use a regular expression to find "місяців" or "місяці"
            const regex = /місяц(ів|і)/;
            const match = text.match(regex);

            // If no match is found, return the original text
            if (!match) {
                return text;
            }
            
            // Calculate the position right after the matched word
            const splitIndex = match.index + match[0].length;

            // If there's nothing after the word, return original text
            if (splitIndex >= text.length) {
                return text;
            }

            // Split the string into the part with the term and the finance part
            const termPart = text.substring(0, splitIndex);
            const financePart = text.substring(splitIndex).trim();

            // If the finance part exists, format it on a new line
            if (financePart) {
                return `${termPart}<br>${financePart} тис. грн.`;
            }

            // Otherwise, return the original text
            return text;
        }
        // **MODIFICATION END**

        function formatScores(text) {
            if (!text) return '';
            
            const cleanedText = text.replace(/\b\d\.\s*/g, '');

            const scores = cleanedText.match(/\d+[.,]?\d*/g);

            if (scores && scores.length >= 3) {
                const average = scores[scores.length - 1];
                const expert2 = scores[scores.length - 2];
                const expert1 = scores[scores.length - 3];
                
                return `1. ${expert1}<br>--------------------<br>2. ${expert2}<br><br><b>${average}</b>`;
            }
            
            return text;
        }

        function processData(data) {
            const groupedData = [];
            let currentThematicDirection = "";
            let currentGroup = null;

            data.forEach(row => {
                const thematicDirection = row['Назва тематичного напряму відповідно наказу МОН України'] || "";

                if (thematicDirection.trim() !== "" && thematicDirection.trim() !== currentThematicDirection) {
                    currentThematicDirection = thematicDirection.trim();
                    if (currentGroup) {
                        groupedData.push(currentGroup);
                    }
                    currentGroup = {
                        thematicDirection: currentThematicDirection,
                        items: []
                    };
                }

                if (currentGroup) {
                    currentGroup.items.push({
                        pib: row['ПІБ наукового керівника, науковий ступінь, вчене звання, назва роботи, категорія та тип роботи'],
                        department: row['Структурний підрозділ'],
                        term: row['Термін виконання та орієнтований обсяг фінансування'],
                        score: row['Бали експертів, середній бал'],
                        commission: row['Дата та № витягу засідання експертної комісії (голова комісії), щодо проходження І етапу Конкурсу']
                    });
                }
            });

            if (currentGroup) {
                groupedData.push(currentGroup);
            }

            return groupedData;
        }

        function generateSlides(data) {
            const slides = [];
            const measuringContainer = document.getElementById('measuring-container');
            const availableHeight = 720; 

            data.forEach(group => {
                let partCounter = 0;
                let itemsForCurrentSlide = [];
                const totalItems = group.items.length;

                const createSlideHTML = (items, thematicDirection, numParts, currentPart) => {
                    let slideHeaderText = thematicDirection;
                     if (numParts > 1) {
                        slideHeaderText += ` (Частина ${currentPart + 1}/${numParts})`;
                    }

                    let bodyRowsHTML = '';
                    for (let i = 0; i < items.length; i++) {
                        const item = items[i];
                        let departmentCellHTML = '';

                        if (i === 0 || items[i].department !== items[i - 1].department) {
                            let rowspan = 1;
                            for (let j = i + 1; j < items.length; j++) {
                                if (items[j].department === item.department) {
                                    rowspan++;
                                } else {
                                    break;
                                }
                            }
                            departmentCellHTML = `<td rowspan="${rowspan}" style="vertical-align: middle; text-align: center;">${item.department || ''}</td>`;
                        }

                        bodyRowsHTML += `
                            <tr>
                                <td>${formatWorkName(item.pib || '')}</td>
                                ${departmentCellHTML}
                                <td>${formatTermAndFinance(item.term || '')}</td>
                                <td>${formatScores(item.score || '')}</td>
                                <td>${item.commission || ''}</td>
                            </tr>
                        `;
                    }

                    return `
                        <div class="slide-content">
                            <div class="slide-header">${slideHeaderText}</div>
                            <table class="slide-table">
                                <thead>
                                    <tr>
                                        <th style="width: 30%;">Науковий керівник, робота</th>
                                        <th style="width: 15%;">Підрозділ</th>
                                        <th style="width: 20%;">Термін та фінансування</th>
                                        <th style="width: 15%;">Бали</th>
                                        <th style="width: 20%;">Витяг з комісії</th>
                                    </tr>
                                </thead>
                                <tbody>${bodyRowsHTML}</tbody>
                            </table>
                        </div>
                    `;
                };
                
                let tempItems = [];
                let estimatedParts = 1;
                for (const item of group.items) {
                    tempItems.push(item);
                    measuringContainer.innerHTML = createSlideHTML(tempItems, group.thematicDirection, 1, 0);
                    if (measuringContainer.scrollHeight > availableHeight) {
                        estimatedParts++;
                        tempItems = [item];
                    }
                }

                for (let i = 0; i < totalItems; i++) {
                    const item = group.items[i];
                    itemsForCurrentSlide.push(item);
                    
                    measuringContainer.innerHTML = createSlideHTML(itemsForCurrentSlide, group.thematicDirection, estimatedParts, partCounter);
                    
                    if (measuringContainer.scrollHeight > availableHeight && itemsForCurrentSlide.length > 1) {
                        const slideItems = itemsForCurrentSlide.slice(0, -1);
                        slides.push(createSlideHTML(slideItems, group.thematicDirection, estimatedParts, partCounter));
                        
                        itemsForCurrentSlide = [item];
                        partCounter++;
                    }
                }

                if (itemsForCurrentSlide.length > 0) {
                    slides.push(createSlideHTML(itemsForCurrentSlide, group.thematicDirection, estimatedParts, partCounter));
                }
            });

            measuringContainer.innerHTML = '';
            return slides;
        }

        function renderSlide(index) {
            const container = document.getElementById('slide-container');
            container.innerHTML = slidesData[index];
            currentSlideIndex = index;
            updateControls();
        }

        function updateControls() {
            document.getElementById('slide-indicator').textContent = `Слайд ${currentSlideIndex + 1} з ${slidesData.length}`;
            document.getElementById('prev-slide').disabled = currentSlideIndex === 0;
            document.getElementById('next-slide').disabled = currentSlideIndex === slidesData.length - 1;
        }

        document.getElementById('prev-slide').addEventListener('click', () => {
            if (currentSlideIndex > 0) {
                renderSlide(currentSlideIndex - 1);
            }
        });

        document.getElementById('next-slide').addEventListener('click', () => {
            if (currentSlideIndex < slidesData.length - 1) {
                renderSlide(currentSlideIndex + 1);
            }
        });

        document.getElementById('download-png').addEventListener('click', () => {
            const slideContainer = document.getElementById('slide-container');
            html2canvas(slideContainer, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `slide_${currentSlideIndex + 1}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        });

        async function downloadAllSlidesAsZip() {
            const zipButton = document.getElementById('download-zip');
            const renderTarget = document.getElementById('measuring-container');
            const zip = new JSZip();

            zipButton.disabled = true;
            zipButton.textContent = 'Генерація...';

            try {
                for (let i = 0; i < slidesData.length; i++) {
                    renderTarget.innerHTML = slidesData[i];
                    const canvas = await html2canvas(renderTarget, { scale: 2 });
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                    zip.file(`slide_${i + 1}.png`, blob);
                }

                const zipContent = await zip.generateAsync({ type: "blob" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(zipContent);
                link.download = 'slides.zip';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);

            } catch (error) {
                console.error("Failed to generate zip file:", error);
                alert("Виникла помилка під час генерації ZIP-файлу.");
            } finally {
                zipButton.disabled = false;
                zipButton.textContent = 'Завантажити всі (ZIP)';
                renderTarget.innerHTML = '';
            }
        }

        async function downloadAllSlidesAsPdf() {
            const pdfButton = document.getElementById('download-pdf');
            const renderTarget = document.getElementById('measuring-container');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'landscape', unit: 'pt', format: [1280, 720] });

            pdfButton.disabled = true;
            pdfButton.textContent = 'Генерація PDF...';

            try {
                for (let i = 0; i < slidesData.length; i++) {
                    renderTarget.innerHTML = slidesData[i];
                    const canvas = await html2canvas(renderTarget, { scale: 2 });
                    const imgData = canvas.toDataURL('image/png');

                    if (i > 0) {
                        pdf.addPage([1280, 720], 'landscape');
                    }
                    pdf.addImage(imgData, 'PNG', 0, 0, 1280, 720);
                }
                pdf.save('slides.pdf');

            } catch (error) {
                console.error("Failed to generate PDF file:", error);
                alert("Виникла помилка під час генерації PDF-файлу.");
            } finally {
                pdfButton.disabled = false;
                pdfButton.textContent = 'Завантажити всі (PDF)';
                renderTarget.innerHTML = '';
            }
        }

        document.getElementById('download-zip').addEventListener('click', downloadAllSlidesAsZip);
        document.getElementById('download-pdf').addEventListener('click', downloadAllSlidesAsPdf);

    </script>

</body>
</html>
